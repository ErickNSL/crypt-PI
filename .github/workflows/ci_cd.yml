name: Senior Data Pipeline CI/CD

# Disparador: Se ejecuta solo cuando hay un push a la rama main
on:
  push:
    branches: [ "main" ]
  # Permite ejecutarlo manualmente desde la interfaz de GitHub si es necesario
  workflow_dispatch:

jobs:
  # TRABAJO 1: INTEGRACIÓN CONTINUA (CI)
  # Valida que el código sea de calidad y funcione antes de siquiera pensar en desplegar.
  quality-gate:
    name: Quality Assurance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip' # Caching nativo para acelerar builds futuros
      
      - name: Install Dependencies (Dev & Prod)
        run: |
          python -m pip install --upgrade pip
          # Instalamos ambos para poder correr los tests
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Linting (Quality Check)
        run: |
          # Ruff es el linter más rápido actualemente. Fallará si hay errores de sintaxis o estilo graves.
          ruff check .

      - name: Unit Testing (Logic Check)
        run: |
          # Ejecuta los tests. Si esto falla, el pipeline se detiene y NO despliega.
          pytest

  # TRABAJO 2: DESPLIEGUE CONTINUO (CD)
  # Solo se ejecuta si 'quality-gate' termina exitosamente.
  deploy:
    name: Deploy to Render
    needs: quality-gate # Dependencia explícita
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # Doble seguridad: solo en rama main
    steps:
      - name: Trigger Render Deployment
        # Usamos curl para golpear el webhook de Render de forma segura
        run: |
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}